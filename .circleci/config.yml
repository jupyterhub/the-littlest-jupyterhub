version: 2
jobs:
    unit-test:
        docker:
            - image: continuumio/miniconda3:4.5.4

        working_directory: ~/repo

        steps:
            - checkout

            # Download and cache dependencies
            - restore_cache:
                keys:
                    - v1-dependencies-miniconda3-4.5.4-{{ checksum "setup.py" }}-{{ checksum "dev-requirements.txt" }}
                    - v1-dependencies-miniconda3-4.5.4-

            - run:
                name: install dependencies
                command: |
                    pip install -r dev-requirements.txt
                    pip install -e .

            - save_cache:
                paths:
                    - /opt/conda
                key: v1-dependencies-miniconda3-4.5.4-{{ checksum "setup.py" }}-{{ checksum "dev-requirements.txt" }}

            - run:
                name: run unit tests
                command: |
                    py.test --cov=tljh tests/

            - run:
                name: upload code coverage stats
                command: |
                    codecov

    integration-test:
        machine: true
        environment:
            cmd: "python3 .circleci/integration-test.py"
            PATH: "$HOME/conda/bin:$PATH"
        steps:
            # Download and cache dependencies
            - restore_cache:
                keys:
                    - v1-integration-miniconda3-4.5.4

            - run:
                name: setup python3.6
                command: |
                    if [[ ! -d "$HOME/conda" ]]; then
                        curl -L https://repo.continuum.io/miniconda/Miniconda3-4.5.4-Linux-x86_64.sh > miniconda.sh
                        bash miniconda.sh -b -p $HOME/conda
                    fi

            - save_cache:
                paths:
                    - $HOME/conda
                key: v1-integration-miniconda3-4.5.4

            - checkout

            - run:
                name: build systemd image
                command: |
                     $cmd build-image

            - run:
                name: start systemd image
                command: |
                    $cmd start-container

            - run:
                name: run tljh installer
                command: |
                    $cmd copy . /srv/src
                    $cmd run 'python3 /srv/src/bootstrap/bootstrap.py'

            - run:
                name: print systemd status + logs
                command: |
                    $cmd run 'journalctl --no-pager'
                    $cmd run 'systemctl --no-pager status jupyterhub configurable-http-proxy'

            - run:
                name: install integration test requirements
                command: |
                    $cmd run 'python3 -m pip install -r /srv/src/integration-tests/requirements.txt'

            - run:
                name: run integration tests
                command: |
                    $cmd run 'python3 -m pytest -v /srv/src/integration-tests'

workflows:
    version: 2
    all-tests:
        jobs:
            - unit-test
            - integration-test
